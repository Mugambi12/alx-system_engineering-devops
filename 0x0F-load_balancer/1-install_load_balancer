#!/usr/bin/env bash
# Configuration script for lb-01 server with HAProxy

# Install HAProxy
sudo apt-get update
sudo apt-get install -y haproxy

# Configure HAProxy
echo '
frontend sm12se.tech
	bind 0:80
	default_backend web_servers

backend web_servers
	balance roundrobin
	server 91903-web-01 54.197.105.254:80 check
	server 91903-web-02 100.24.206.145:80 check
' >> /etc/haproxy/haproxy.cfg

# Enable HAProxy via defaults file
sudo sed -i '/CONFIG=/c\CONFIG="/etc/haproxy/haproxy.cfg"' /etc/default/haproxy
sudo sed -i '/EXTRAOPTS=/c\EXTRAOPTS="-de -m 16"' /etc/default/haproxy

# Restart HAProxy
sudo service haproxy restart
